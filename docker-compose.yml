version: '3.8'

services:
  django:
    build: .
    container_name: postflow_django
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pgrep cron && pgrep uwsgi"]
      interval: 30s
      timeout: 5s
      retries: 3
    env_file:
      - ./core/.env
    ports:
      - "8000:8000"
    volumes:
      - static_volume:/app/static
      - media_volume:/app/media
    command: >
      uwsgi --http 0.0.0.0:8000 --protocol uwsgi --wsgi core.wsgi:application

  nginx:
    build:
      context: ./AWS/nginx
    container_name: postflow_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - django
    volumes:
      - static_volume:/app/static
      - media_volume:/app/media
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt

  certbot-renewer:
    image: certbot/certbot
    container_name: certbot_renewer
    restart: always
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock
    # Checks twice a day. If certs changed, signals NGINX (HUP) via Docker API.
    entrypoint: >
      sh -c 'while :; do
               changed=0
               before=$(find /etc/letsencrypt/live -type f \( -name fullchain.pem -o -name privkey.pem \) -printf "%T@ %p\n" 2>/dev/null | sort -n | tail -1 | cut -d" " -f1)
               certbot renew --webroot --webroot-path=/var/www/certbot --quiet || true
               after=$(find /etc/letsencrypt/live -type f \( -name fullchain.pem -o -name privkey.pem \) -printf "%T@ %p\n" 2>/dev/null | sort -n | tail -1 | cut -d" " -f1)
               if [ -n "$before" ] && [ -n "$after" ] && [ "$after" != "$before" ]; then
                 changed=1
               fi
               if [ "$changed" = "1" ]; then
                 # Reload NGINX inside the postflow_nginx container without docker CLI
                 curl --unix-socket /var/run/docker.sock -X POST http://localhost/v1.41/containers/postflow_nginx/kill?signal=HUP \
                 || curl --unix-socket /var/run/docker.sock -X POST http://localhost/v1.24/containers/postflow_nginx/kill?signal=HUP \
                 || true
               fi
               sleep 12h;
             done'

volumes:
  static_volume:
  media_volume:
